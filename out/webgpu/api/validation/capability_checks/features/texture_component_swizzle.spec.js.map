{"version":3,"file":"texture_component_swizzle.spec.js","names":["description","makeTestGroup","GPUConst","UniqueFeaturesOrLimitsGPUTest","isIdentitySwizzle","kSwizzleTests","swizzlesAreTheSame","swizzleSpecToGPUTextureComponentSwizzle","g","test","desc","params","u","beginSubcases","combine","fn","t","swizzleSpec","swizzle","texture","createTextureTracked","format","size","usage","GPUTextureUsage","COPY_DST","TEXTURE_BINDING","shouldError","expectValidationError","createView","TextureUsage","COPY_SRC","RENDER_ATTACHMENT","STORAGE_BINDING","beforeAllSubcases","selectDeviceOrSkipTestCase","badUsage","otherSwizzleSpec","pipelineType","otherSwizzle","module","device","createShaderModule","code","pipeline","createComputePipeline","layout","compute","createRenderPipeline","vertex","fragment","targets","bindGroup0","createBindGroup","getBindGroupLayout","entries","binding","resource","bindGroup1","encoder","createCommandEncoder","pass","beginComputePass","setPipeline","setBindGroup","dispatchWorkgroups","end","view","beginRenderPass","colorAttachments","loadOp","storeOp","draw","isCompatibility","finish"],"sources":["../../../../../../src/webgpu/api/validation/capability_checks/features/texture_component_swizzle.spec.ts"],"sourcesContent":["export const description = `\nValidation tests for the 'texture-component-swizzle' feature.\n\nTest that:\n* when the feature is off, swizzling is not allowed, even the identity swizzle.\n* swizzling is not allowed on textures with usage STORAGE_BINDING nor RENDER_ATTACHMENT\n  except the identity swizzle.\n`;\n\nimport { makeTestGroup } from '../../../../../common/framework/test_group.js';\nimport { GPUConst } from '../../../../constants.js';\nimport { UniqueFeaturesOrLimitsGPUTest } from '../../../../gpu_test.js';\n\nimport {\n  isIdentitySwizzle,\n  kSwizzleTests,\n  swizzlesAreTheSame,\n  swizzleSpecToGPUTextureComponentSwizzle,\n} from './texture_component_swizzle_utils.js';\n\nexport const g = makeTestGroup(UniqueFeaturesOrLimitsGPUTest);\n\ng.test('only_identity_swizzle')\n  .desc(\n    `\n  Test that if texture-component-swizzle is not enabled, having a non-default swizzle property generates a validation error.\n  `\n  )\n  .params(u => u.beginSubcases().combine('swizzleSpec', kSwizzleTests))\n  .fn(t => {\n    const { swizzleSpec } = t.params;\n    const swizzle = swizzleSpecToGPUTextureComponentSwizzle(swizzleSpec);\n    const texture = t.createTextureTracked({\n      format: 'rgba8unorm',\n      size: [1],\n      usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.TEXTURE_BINDING,\n    });\n    const shouldError = !isIdentitySwizzle(swizzle);\n    t.expectValidationError(() => {\n      texture.createView({ swizzle });\n    }, shouldError);\n  });\n\ng.test('no_render_nor_storage')\n  .desc(\n    `\n  Test that setting the swizzle on the texture with RENDER_ATTACHMENT or STORAGE_BINDING usage works\n  if the swizzle is the identity but generates a validation error otherwise.\n  `\n  )\n  .params(u =>\n    u\n      .combine('usage', [\n        GPUConst.TextureUsage.COPY_SRC,\n        GPUConst.TextureUsage.COPY_DST,\n        GPUConst.TextureUsage.TEXTURE_BINDING,\n        GPUConst.TextureUsage.RENDER_ATTACHMENT,\n        GPUConst.TextureUsage.STORAGE_BINDING,\n      ] as const)\n      .beginSubcases()\n      .combine('swizzleSpec', kSwizzleTests)\n  )\n  .beforeAllSubcases(t => {\n    // MAINTENANCE_TODO: Remove this cast once texture-component-swizzle is added to @webgpu/types\n    t.selectDeviceOrSkipTestCase('texture-component-swizzle' as GPUFeatureName);\n  })\n  .fn(t => {\n    const { swizzleSpec, usage } = t.params;\n    const swizzle = swizzleSpecToGPUTextureComponentSwizzle(swizzleSpec);\n    const texture = t.createTextureTracked({\n      format: 'rgba8unorm',\n      size: [1],\n      usage,\n    });\n    const badUsage =\n      (usage &\n        (GPUConst.TextureUsage.RENDER_ATTACHMENT | GPUConst.TextureUsage.STORAGE_BINDING)) !==\n      0;\n    const shouldError = badUsage && !isIdentitySwizzle(swizzle);\n    t.expectValidationError(() => {\n      texture.createView({ swizzle });\n    }, shouldError);\n  });\n\ng.test('compatibility_mode')\n  .desc(\n    `\n  Test that in compatibility mode, swizzles must be equivalent.\n  `\n  )\n  .beforeAllSubcases(t => {\n    // MAINTENANCE_TODO: Remove this cast once texture-component-swizzle is added to @webgpu/types\n    t.selectDeviceOrSkipTestCase('texture-component-swizzle' as GPUFeatureName);\n  })\n  .params(u =>\n    u\n      .beginSubcases()\n      .combine('swizzleSpec', kSwizzleTests)\n      .combine('otherSwizzleSpec', kSwizzleTests)\n      .combine('pipelineType', ['render', 'compute'] as const)\n  )\n  .fn(t => {\n    const { swizzleSpec, otherSwizzleSpec, pipelineType } = t.params;\n    const swizzle = swizzleSpecToGPUTextureComponentSwizzle(swizzleSpec);\n    const otherSwizzle = swizzleSpecToGPUTextureComponentSwizzle(otherSwizzleSpec);\n\n    const module = t.device.createShaderModule({\n      code: `\n        @group(0) @binding(0) var tex0: texture_2d<f32>;\n        @group(1) @binding(0) var tex1: texture_2d<f32>;\n\n        @compute @workgroup_size(1) fn cs() {\n          _ = tex0;\n          _ = tex1;\n        }\n\n        @vertex fn vs() -> @builtin(position) vec4f {\n          return vec4f(0);\n        }\n\n        @fragment fn fs() -> @location(0) vec4f {\n          _ = tex0;\n          _ = tex1;\n          return vec4f(0);\n        }\n      `,\n    });\n\n    const pipeline =\n      pipelineType === 'compute'\n        ? t.device.createComputePipeline({\n            layout: 'auto',\n            compute: { module },\n          })\n        : t.device.createRenderPipeline({\n            layout: 'auto',\n            vertex: { module },\n            fragment: { module, targets: [{ format: 'rgba8unorm' }] },\n          });\n\n    const texture = t.createTextureTracked({\n      size: [1],\n      format: 'rgba8unorm',\n      usage: GPUTextureUsage.TEXTURE_BINDING,\n    });\n\n    const bindGroup0 = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: texture.createView({ swizzle }),\n        },\n      ],\n    });\n\n    const bindGroup1 = t.device.createBindGroup({\n      layout: pipeline.getBindGroupLayout(0),\n      entries: [\n        {\n          binding: 0,\n          resource: texture.createView({ swizzle: otherSwizzle }),\n        },\n      ],\n    });\n\n    const encoder = t.device.createCommandEncoder();\n    switch (pipelineType) {\n      case 'compute': {\n        const pass = encoder.beginComputePass();\n        pass.setPipeline(pipeline as GPUComputePipeline);\n        pass.setBindGroup(0, bindGroup0);\n        pass.setBindGroup(1, bindGroup1);\n        pass.dispatchWorkgroups(1);\n        pass.end();\n        break;\n      }\n      case 'render': {\n        const view = t.createTextureTracked({\n          size: [1],\n          format: 'rgba8unorm',\n          usage: GPUTextureUsage.RENDER_ATTACHMENT,\n        });\n        const pass = encoder.beginRenderPass({\n          colorAttachments: [{ view, loadOp: 'clear', storeOp: 'store' }],\n        });\n        pass.setPipeline(pipeline as GPURenderPipeline);\n        pass.setBindGroup(0, bindGroup0);\n        pass.setBindGroup(1, bindGroup1);\n        pass.draw(3);\n        pass.end();\n      }\n    }\n\n    const shouldError = t.isCompatibility && !swizzlesAreTheSame(swizzle, otherSwizzle);\n\n    t.expectValidationError(() => {\n      encoder.finish();\n    }, shouldError);\n  });\n"],"mappings":";;GAAA,OAAO,MAAMA,WAAW,GAAI;AAC5B;AACA;AACA;AACA;AACA;AACA;AACA,CAAC,CAED,SAASC,aAAa,QAAQ,+CAA+C;AAC7E,SAASC,QAAQ,QAAQ,0BAA0B;AACnD,SAASC,6BAA6B,QAAQ,yBAAyB;;AAEvE;EACEC,iBAAiB;EACjBC,aAAa;EACbC,kBAAkB;EAClBC,uCAAuC;AAClC,sCAAsC;;AAE7C,OAAO,MAAMC,CAAC,GAAGP,aAAa,CAACE,6BAA6B,CAAC;;AAE7DK,CAAC,CAACC,IAAI,CAAC,uBAAuB,CAAC;AAC5BC,IAAI;EACF;AACL;AACA;AACE,CAAC;AACAC,MAAM,CAAC,CAAAC,CAAC,KAAIA,CAAC,CAACC,aAAa,CAAC,CAAC,CAACC,OAAO,CAAC,aAAa,EAAET,aAAa,CAAC,CAAC;AACpEU,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAM,EAAEC,WAAW,CAAC,CAAC,GAAGD,CAAC,CAACL,MAAM;EAChC,MAAMO,OAAO,GAAGX,uCAAuC,CAACU,WAAW,CAAC;EACpE,MAAME,OAAO,GAAGH,CAAC,CAACI,oBAAoB,CAAC;IACrCC,MAAM,EAAE,YAAY;IACpBC,IAAI,EAAE,CAAC,CAAC,CAAC;IACTC,KAAK,EAAEC,eAAe,CAACC,QAAQ,GAAGD,eAAe,CAACE;EACpD,CAAC,CAAC;EACF,MAAMC,WAAW,GAAG,CAACvB,iBAAiB,CAACc,OAAO,CAAC;EAC/CF,CAAC,CAACY,qBAAqB,CAAC,MAAM;IAC5BT,OAAO,CAACU,UAAU,CAAC,EAAEX,OAAO,CAAC,CAAC,CAAC;EACjC,CAAC,EAAES,WAAW,CAAC;AACjB,CAAC,CAAC;;AAEJnB,CAAC,CAACC,IAAI,CAAC,uBAAuB,CAAC;AAC5BC,IAAI;EACF;AACL;AACA;AACA;AACE,CAAC;AACAC,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC;AACEE,OAAO,CAAC,OAAO,EAAE;AAChBZ,QAAQ,CAAC4B,YAAY,CAACC,QAAQ;AAC9B7B,QAAQ,CAAC4B,YAAY,CAACL,QAAQ;AAC9BvB,QAAQ,CAAC4B,YAAY,CAACJ,eAAe;AACrCxB,QAAQ,CAAC4B,YAAY,CAACE,iBAAiB;AACvC9B,QAAQ,CAAC4B,YAAY,CAACG,eAAe;AAC7B,CAAC;AACVpB,aAAa,CAAC,CAAC;AACfC,OAAO,CAAC,aAAa,EAAET,aAAa;AACzC,CAAC;AACA6B,iBAAiB,CAAC,CAAAlB,CAAC,KAAI;EACtB;EACAA,CAAC,CAACmB,0BAA0B,CAAC,2BAA6C,CAAC;AAC7E,CAAC,CAAC;AACDpB,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAM,EAAEC,WAAW,EAAEM,KAAK,CAAC,CAAC,GAAGP,CAAC,CAACL,MAAM;EACvC,MAAMO,OAAO,GAAGX,uCAAuC,CAACU,WAAW,CAAC;EACpE,MAAME,OAAO,GAAGH,CAAC,CAACI,oBAAoB,CAAC;IACrCC,MAAM,EAAE,YAAY;IACpBC,IAAI,EAAE,CAAC,CAAC,CAAC;IACTC;EACF,CAAC,CAAC;EACF,MAAMa,QAAQ;EACZ,CAACb,KAAK;EACHrB,QAAQ,CAAC4B,YAAY,CAACE,iBAAiB,GAAG9B,QAAQ,CAAC4B,YAAY,CAACG,eAAe,CAAC;EACnF,CAAC;EACH,MAAMN,WAAW,GAAGS,QAAQ,IAAI,CAAChC,iBAAiB,CAACc,OAAO,CAAC;EAC3DF,CAAC,CAACY,qBAAqB,CAAC,MAAM;IAC5BT,OAAO,CAACU,UAAU,CAAC,EAAEX,OAAO,CAAC,CAAC,CAAC;EACjC,CAAC,EAAES,WAAW,CAAC;AACjB,CAAC,CAAC;;AAEJnB,CAAC,CAACC,IAAI,CAAC,oBAAoB,CAAC;AACzBC,IAAI;EACF;AACL;AACA;AACE,CAAC;AACAwB,iBAAiB,CAAC,CAAAlB,CAAC,KAAI;EACtB;EACAA,CAAC,CAACmB,0BAA0B,CAAC,2BAA6C,CAAC;AAC7E,CAAC,CAAC;AACDxB,MAAM,CAAC,CAAAC,CAAC;AACPA,CAAC;AACEC,aAAa,CAAC,CAAC;AACfC,OAAO,CAAC,aAAa,EAAET,aAAa,CAAC;AACrCS,OAAO,CAAC,kBAAkB,EAAET,aAAa,CAAC;AAC1CS,OAAO,CAAC,cAAc,EAAE,CAAC,QAAQ,EAAE,SAAS,CAAU;AAC3D,CAAC;AACAC,EAAE,CAAC,CAAAC,CAAC,KAAI;EACP,MAAM,EAAEC,WAAW,EAAEoB,gBAAgB,EAAEC,YAAY,CAAC,CAAC,GAAGtB,CAAC,CAACL,MAAM;EAChE,MAAMO,OAAO,GAAGX,uCAAuC,CAACU,WAAW,CAAC;EACpE,MAAMsB,YAAY,GAAGhC,uCAAuC,CAAC8B,gBAAgB,CAAC;;EAE9E,MAAMG,MAAM,GAAGxB,CAAC,CAACyB,MAAM,CAACC,kBAAkB,CAAC;IACzCC,IAAI,EAAG;AACb;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACI,CAAC,CAAC;;EAEF,MAAMC,QAAQ;EACZN,YAAY,KAAK,SAAS;EACtBtB,CAAC,CAACyB,MAAM,CAACI,qBAAqB,CAAC;IAC7BC,MAAM,EAAE,MAAM;IACdC,OAAO,EAAE,EAAEP,MAAM,CAAC;EACpB,CAAC,CAAC;EACFxB,CAAC,CAACyB,MAAM,CAACO,oBAAoB,CAAC;IAC5BF,MAAM,EAAE,MAAM;IACdG,MAAM,EAAE,EAAET,MAAM,CAAC,CAAC;IAClBU,QAAQ,EAAE,EAAEV,MAAM,EAAEW,OAAO,EAAE,CAAC,EAAE9B,MAAM,EAAE,YAAY,CAAC,CAAC,CAAC,CAAC;EAC1D,CAAC,CAAC;;EAER,MAAMF,OAAO,GAAGH,CAAC,CAACI,oBAAoB,CAAC;IACrCE,IAAI,EAAE,CAAC,CAAC,CAAC;IACTD,MAAM,EAAE,YAAY;IACpBE,KAAK,EAAEC,eAAe,CAACE;EACzB,CAAC,CAAC;;EAEF,MAAM0B,UAAU,GAAGpC,CAAC,CAACyB,MAAM,CAACY,eAAe,CAAC;IAC1CP,MAAM,EAAEF,QAAQ,CAACU,kBAAkB,CAAC,CAAC,CAAC;IACtCC,OAAO,EAAE;IACP;MACEC,OAAO,EAAE,CAAC;MACVC,QAAQ,EAAEtC,OAAO,CAACU,UAAU,CAAC,EAAEX,OAAO,CAAC,CAAC;IAC1C,CAAC;;EAEL,CAAC,CAAC;;EAEF,MAAMwC,UAAU,GAAG1C,CAAC,CAACyB,MAAM,CAACY,eAAe,CAAC;IAC1CP,MAAM,EAAEF,QAAQ,CAACU,kBAAkB,CAAC,CAAC,CAAC;IACtCC,OAAO,EAAE;IACP;MACEC,OAAO,EAAE,CAAC;MACVC,QAAQ,EAAEtC,OAAO,CAACU,UAAU,CAAC,EAAEX,OAAO,EAAEqB,YAAY,CAAC,CAAC;IACxD,CAAC;;EAEL,CAAC,CAAC;;EAEF,MAAMoB,OAAO,GAAG3C,CAAC,CAACyB,MAAM,CAACmB,oBAAoB,CAAC,CAAC;EAC/C,QAAQtB,YAAY;IAClB,KAAK,SAAS,CAAE;QACd,MAAMuB,IAAI,GAAGF,OAAO,CAACG,gBAAgB,CAAC,CAAC;QACvCD,IAAI,CAACE,WAAW,CAACnB,QAA8B,CAAC;QAChDiB,IAAI,CAACG,YAAY,CAAC,CAAC,EAAEZ,UAAU,CAAC;QAChCS,IAAI,CAACG,YAAY,CAAC,CAAC,EAAEN,UAAU,CAAC;QAChCG,IAAI,CAACI,kBAAkB,CAAC,CAAC,CAAC;QAC1BJ,IAAI,CAACK,GAAG,CAAC,CAAC;QACV;MACF;IACA,KAAK,QAAQ,CAAE;QACb,MAAMC,IAAI,GAAGnD,CAAC,CAACI,oBAAoB,CAAC;UAClCE,IAAI,EAAE,CAAC,CAAC,CAAC;UACTD,MAAM,EAAE,YAAY;UACpBE,KAAK,EAAEC,eAAe,CAACQ;QACzB,CAAC,CAAC;QACF,MAAM6B,IAAI,GAAGF,OAAO,CAACS,eAAe,CAAC;UACnCC,gBAAgB,EAAE,CAAC,EAAEF,IAAI,EAAEG,MAAM,EAAE,OAAO,EAAEC,OAAO,EAAE,OAAO,CAAC,CAAC;QAChE,CAAC,CAAC;QACFV,IAAI,CAACE,WAAW,CAACnB,QAA6B,CAAC;QAC/CiB,IAAI,CAACG,YAAY,CAAC,CAAC,EAAEZ,UAAU,CAAC;QAChCS,IAAI,CAACG,YAAY,CAAC,CAAC,EAAEN,UAAU,CAAC;QAChCG,IAAI,CAACW,IAAI,CAAC,CAAC,CAAC;QACZX,IAAI,CAACK,GAAG,CAAC,CAAC;MACZ;EACF;;EAEA,MAAMvC,WAAW,GAAGX,CAAC,CAACyD,eAAe,IAAI,CAACnE,kBAAkB,CAACY,OAAO,EAAEqB,YAAY,CAAC;;EAEnFvB,CAAC,CAACY,qBAAqB,CAAC,MAAM;IAC5B+B,OAAO,CAACe,MAAM,CAAC,CAAC;EAClB,CAAC,EAAE/C,WAAW,CAAC;AACjB,CAAC,CAAC"}